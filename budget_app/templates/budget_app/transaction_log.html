{% extends 'budget_app/base.html' %}

{% load staticfiles %}

{% block login_info %}
    {% if user.is_authenticated %}
        Logged in as {{ username }}.
    {% endif %}
{% endblock %}

    <!--
        Junk here, but I used these colors:
    
          backgroundColor: [
            "#2ecc71",
            "#3498db",
            "#95a5a6",
            "#9b59b6",
            "#f1c40f",
            "#e74c3c",
            "#34495e"
          ],
    -->

{% block trends %}
    <h4>
        Money Over Time: 
        <span class="trends-header-range">{{date_range_start}} - {{date_range_end}}</span>
    </h4>
    
    <div class="canvas-wrapper">
        <canvas id="lineChartCanvas" width="600" height="380"></canvas>
    </div>

    {% if statistics_list %}
    <div id="trends-stats" class="card card-sm">
        <div class="card-header bg-dark text-light">
            Statistics over
            <span class="trends-header-range">{{date_range_start}} - {{date_range_end}}</span>
        </div>

        <ul class="list-group list-group-flush">
            {% for stat in statistics_list %}
            <li class="list-group-item">
                <strong>{{stat.name}}</strong>
                <span class="statistic_value" id="stat-{{stat.id}}">
                    {{stat.value}}
                </span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
{% endblock %}

{% block categories %}
    <h1>Most Common Expenses</h1>

    <div class="canvas-wrapper">
        <canvas id="pieChartCanvas" width="600" height="380"></canvas>
    </div>
{% endblock %}

{% block transaction_container %}
    <form method="POST" action="{% url 'transaction_add' %}" id="transaction-form">
        {% csrf_token %}
        {# transaction_form.as_p #}

        {% for error in transaction_form.non_field_errors %}
            <div class="form-group text-danger small">
                {{error}}
            </div>
        {% endfor%}

        {% for field in transaction_form %}
            <div class="form-group text-danger small">
                {{field.errors}}
            </div>
            <div class="form-group">
                <div class="input-group">
                    <span class="input-group-addon">
                        <!-- this is a little gross, but I'm not sure of a better way -->
                        {% if field.label == "Value" %}
                        <span class="icon ion-social-usd">
                        {% elif field.label == "Memo"%}
                        <span class="icon ion-ios-bookmarks">
                        {% endif %}
                        </span>
                    </span>
                    {{field}}
                </div>
            </div>
        {% endfor %}
        <div class="form-group">
            <div class="input-group">
                <span class="input-group-addon">
                    <span class="icon ion-filing"></span>
                </span>
                <input class="form-control" type="text" name="category_string" id="category-string" placeholder="Category">
            </div>
        </div>

        <div class="form-group">
            <div class="input-group">
                <span class="input-group-addon">
                    <span class="icon ion-ios-calendar-outline"></span>
                </span>
                <input class="form-control" type="text" name="date_string" id="date-string"
                data-date-format="mm/dd/yy" data-language="en">
            </div>
        </div>

        <div class="form-group">
            <input class="btn btn-primary" type="submit" value="Add Transaction">
        </div>
    </form>
{% endblock %}


{% block content %}
    <h2>Transactions</h2>

    <label for="date-range">Date Range: </label>
    <input type="text" readonly id="date-range" 
    data-date-format="mm/dd/yy" data-language="en" data-multiple-dates-separator=" - " data-range="true" 
    value="{{date_range_start}} - {{date_range_end}}">

    {% if all_boolean %}
    <a href="{% url 'transaction_log' all_boolean='all' %}" id="date-range-all" class="all-selected">
    {% else %}
    <a href="{% url 'transaction_log' all_boolean='all' %}" id="date-range-all">
    {% endif %}
        All Transactions
    </a>

    <div id="table-wrapper">
        {% include 'budget_app/transaction_table.html' %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function(){

        lineChart = drawLinechart({{range_start_funds}}, {{pos_change_vals}}, {{neg_change_vals}}, 
            {{dates_in_range|safe}}, $("#lineChartCanvas"));
        pieChart = drawPieChart({{sorted_expense_cat|safe}}, {{sorted_expense_val}}, $("pieChartCanvas"));

        var dateRangeArray = [new Date("{{date_start_iso}}"), new Date("{{date_end_iso}}")];
        $("#date-range").datepicker().data('datepicker').selectDate(dateRangeArray);
        $("#date-range").datepicker().data('datepicker').update('minDate', new Date("{{date_start_bound}}"));

        $("#date-string").datepicker().data('datepicker').selectDate(new Date());
        $("#date-string").datepicker().data('datepicker').update('minDate', new Date("{{date_start_bound}}"));

        //If JS is enabled, make sure the "All Time" link makes an ajax request
        $("#date-range-all").on("click", function(event){
            event.preventDefault();

            var dateRangeData = $("#date-range").datepicker().data('datepicker');

            //var allDateRangeArray = [new Date("{{date_start_bound}}"), new Date("{{date_end_iso}}")]
            var allDateRangeArray = [dateRangeData.minDate, dateRangeData.maxDate]
            $("#date-range").datepicker().data('datepicker').selectDate(allDateRangeArray); 
        });
    });
</script>
{% endblock %}